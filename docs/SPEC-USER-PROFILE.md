# ユーザー検索・プロファイル機能 仕様書

> 作成日: 2025-12-14
> 更新日: 2025-12-15
> ステータス: Phase 2 実装完了（バッジ・OGカード・ヒートマップ・貢献タイプ分布）

## 1. 概要

### 1.1 目的
ユーザー（GitHub アカウント）を検索し、その活動統計を可視化する機能を提供する。

### 1.2 ユースケース
- 他の開発者のGitHub活動を確認したい
- 特定ユーザーのOGカードを生成・共有したい
- 自分のGitHubプロファイルを可視化したい

### 1.3 スコープ
| 含む | 含まない |
|------|----------|
| ユーザー検索 | 組織(Organization)検索 |
| ユーザープロファイルページ | ユーザー間比較 |
| 統計グラフ表示 | プライベート統計 |
| OGカード生成（既存機能連携） | フォロー/アンフォロー操作 |

---

## 2. 統一レイアウトアーキテクチャ

### 2.1 設計方針

全ページで一貫したUI/UXを提供するため、以下の方針を採用する：

| 方針 | 詳細 |
|------|------|
| **共通ヘッダー** | ロゴ + 認証状態を全ページで表示 |
| **常時検索バー** | リポジトリ・ユーザー検索を全ページで可能に |
| **戻るボタン廃止** | 検索バーで再検索できるため不要 |
| **デザイン統一** | 背景・カード・タイポグラフィを統一 |

### 2.2 統一レイアウト構造

```
┌──────────────────────────────────────────────────────────────┐
│  [ロゴ]  GitHub Insights        [ユーザーアバター] [Logout]  │  ← AppHeader
├──────────────────────────────────────────────────────────────┤
│  🔍 リポジトリ・ユーザーを検索...                             │  ← SearchBar
├──────────────────────────────────────────────────────────────┤
│                                                              │
│     [現在表示中のコンテンツ]                                  │  ← PageContent
│     - リポジトリ統計 (/repo/[owner]/[repo])                  │
│     - ユーザープロファイル (/user/[username])                │
│     - ダッシュボード (/dashboard)                            │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 2.3 デザイントークン

| 要素 | 値 |
|------|-----|
| **背景** | `bg-linear-to-br from-gray-50 via-purple-50/30 to-gray-50` |
| **ダーク背景** | `dark:from-gray-800 dark:via-purple-900/30 dark:to-gray-800` |
| **ヘッダー** | `bg-white/80 dark:bg-gray-800/80 backdrop-blur` |
| **カード** | `bg-white/80 dark:bg-gray-800/80 backdrop-blur rounded-xl shadow-lg border border-gray-200/50 dark:border-gray-700/50` |
| **アクセントカラー** | `purple-500` / `pink-500` |

### 2.4 共通コンポーネント

| コンポーネント | 役割 | 使用ページ |
|---------------|------|-----------|
| `AppHeader` | ロゴ + 認証状態 + ログアウト | 全ページ |
| `SearchHeader` | 検索バー（リポジトリ + ユーザー） | 全ページ |
| `DashboardLayout` | ヘッダー + 検索 + コンテンツ領域 | 全ページ |
| `StatCard` | 統計値表示カード | ダッシュボード, ユーザーページ |

---

## 3. ユーザーフロー

```
[任意のページの検索バー] 
    │
    ├─ "facebook/react" → リポジトリ検索
    │         │
    │         ▼
    │   [/repo/facebook/react]
    │         │
    │         └─ 検索バーから別のリポジトリ/ユーザーへ遷移可能
    │
    └─ "@torvalds" → ユーザー検索
              │
              ▼
        [検索結果表示]
              │
              ▼
        [ユーザー選択]
              │
              ▼
        [/user/torvalds]
              │
              ├─ プロファイル情報
              ├─ 統計グラフ
              ├─ OGカード生成
              └─ 検索バーから別のリポジトリ/ユーザーへ遷移可能
```

---

## 4. 検索機能

### 4.1 検索トリガー
- `@` で始まる入力をユーザー検索として処理
- 2文字以上で検索開始（デバウンス: 300ms）

### 4.2 検索API
```
GET https://api.github.com/search/users?q={query}&per_page=5
```

### 4.3 検索結果の詳細取得
Search API のレスポンスには詳細情報がないため、上位5件に対して追加取得:
```
GET https://api.github.com/users/{login}
```

### 4.4 検索結果の表示項目

> ⚠️ **実装時の変更**: レート制限対策として、Search APIの結果のみを使用。詳細情報（name, followers, publicRepos）はユーザープロファイルページで表示。

| 項目 | 必須 | ソース | 実装状況 |
|------|------|--------|----------|
| アバター画像 | ✅ | Search API | ✅ 実装済み |
| ログイン名 (`login`) | ✅ | Search API | ✅ 実装済み |
| 表示名 (`name`) | ○ | Users API | ❌ 検索結果では省略（プロファイルページで表示） |
| フォロワー数 | ○ | Users API | ❌ 検索結果では省略（プロファイルページで表示） |
| 公開リポジトリ数 | ○ | Users API | ❌ 検索結果では省略（プロファイルページで表示） |
| User/Organization 区別 | △ | Search API (`type`) | ✅ 実装済み |

### 4.5 検索結果UIモック

```
┌─────────────────────────────────────────────────────┐
│ 🔍 @torvalds                                    [×] │
└─────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────┐
│ 👤 ユーザー                                          │
├─────────────────────────────────────────────────────┤
│ ┌────┐  torvalds                                    │
│ │ 🖼️ │  Linus Torvalds                              │
│ └────┘  👥 200k · 📦 7 repos                        │
├─────────────────────────────────────────────────────┤
│ ┌────┐  torvalds-test                               │
│ │ 🖼️ │  Test Account                                │
│ └────┘  👥 5 · 📦 2 repos                           │
└─────────────────────────────────────────────────────┘
```

---

## 5. ユーザープロファイルページ

### 5.1 ルーティング
```
/user/[username]
```

### 5.2 データ取得

| データ | API | キャッシュ |
|--------|-----|-----------|
| ユーザー基本情報 | `GET /users/{username}` | 1時間 |
| リポジトリ一覧 | `GET /users/{username}/repos?sort=stars&per_page=100` | 1時間 |
| PR数 | `GET /search/issues?q=author:{user}+type:pr` | 1時間 |
| Issue数 | `GET /search/issues?q=author:{user}+type:issue` | 1時間 |
| イベント履歴 | `GET /users/{username}/events?per_page=100` | 30分 |

### 5.3 ページレイアウト

> 統一レイアウトアーキテクチャ（セクション2）に準拠。共通ヘッダー + 検索バーを使用。

```
┌──────────────────────────────────────────────────────────────┐
│  [ロゴ]  GitHub Insights        [ユーザーアバター] [Logout]  │  ← AppHeader
├──────────────────────────────────────────────────────────────┤
│  🔍 リポジトリ・ユーザーを検索...                             │  ← SearchBar
├──────────────────────────────────────────────────────────────┤
│ ┌──────────────────────────────────────────────────────────┐ │
│ │ ┌──────┐                                                 │ │
│ │ │ 🖼️   │  torvalds                     [GitHub↗]        │ │  ← プロファイルカード
│ │ │      │  Linus Torvalds                                │ │
│ │ └──────┘  📍 Portland, OR                                │ │
│ │           👥 200k followers · 👤 0 following             │ │
│ │           📦 7 public repos · 📅 Joined 2011             │ │
│ │           🏅 Veteran · Influencer · Prolific             │ │
│ │           [📷 カードを生成]                               │ │
│ └──────────────────────────────────────────────────────────┘ │
├──────────────────────────────────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌──────────┐ │
│ │ リポジトリ   │ │ 獲得スター   │ │ 被フォーク   │ │ 言語数    │ │  ← 統計カード
│ │     7       │ │   180k     │ │    25k     │ │    5     │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └──────────┘ │
├──────────────────────────────────────────────────────────────┤
│ ┌────────────────────────────┐ ┌────────────────────────────┐ │
│ │    📊 使用言語              │ │   ⭐ 人気リポジトリ         │ │
│ │    ┌───────────┐          │ │   1. linux      ⭐ 180k   │ │
│ │    │  C: 80%   │          │ │   2. subsurface ⭐ 2.1k   │ │
│ │    │ Shell:15% │          │ │   3. test-tlb   ⭐ 500    │ │
│ │    └───────────┘          │ │   4. uemacs     ⭐ 300    │ │
│ └────────────────────────────┘ └────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

### 5.4 統計グラフ

| グラフ | 種類 | データソース | 説明 | 実装状況 |
|--------|------|-------------|------|----------|
| 言語統計 | 円グラフ | リポジトリ一覧の `language` | 全リポジトリの言語割合 | ✅ 実装済み |
| アクティビティ | ヒートマップ | イベント履歴 | 直近90日の活動頻度 | ❌ 未実装（Phase 2） |
| 貢献タイプ分布 | 円グラフ | PR数/Issue数/イベント | 活動の内訳 | ❌ 未実装（Phase 2） |
| 人気リポジトリ | リスト | リポジトリ一覧 | スター数上位5件 | ✅ 実装済み |

### 5.5 バッジ

`lib/badges.ts` の `calculateUserBadges()` を使用してバッジを計算・表示。

| バッジID | 表示名 | 条件 | カテゴリ |
|----------|--------|------|----------|
| `influencer` | Influencer | フォロワー 1,000人以上 | user |
| `popular` | Popular | フォロワー 100人以上 | user |
| `prolific` | Prolific | リポジトリ 50個以上 | user |
| `builder` | Builder | リポジトリ 20個以上 | user |
| `user_pr_master` | PR Master | PR 100件以上 | user |
| `user_contributor` | Contributor | PR 50件以上 | user |
| `veteran` | Veteran | 2015年以前にアカウント作成 | user |

**UI仕様:**
- プロファイルカード内にバッジチップとして表示（最大4個）
- 5個以上の場合は「+N」表示
- クリックでポップオーバー（全バッジ一覧）
- モバイル: フルスクリーンモーダル
- デスクトップ: 相対位置ポップオーバー
- アクセシビリティ: `aria-expanded`, `aria-label` 対応

### 5.6 OGカード生成

✅ **実装済み**: `UserCardModal` コンポーネントで実装。

**機能:**
| 機能 | 説明 |
|------|------|
| プレビュー | `/api/og/card/user/[username]` からOG画像を表示 |
| ダウンロード | PNG形式でダウンロード（`{username}-github-card.png`） |
| URL コピー | OG画像の完全URLをクリップボードにコピー |
| Markdown コピー | 埋め込み用Markdownをコピー（特殊文字エスケープ対応） |

**Markdownエスケープ:**
- `[]()` などMarkdown構文に影響する文字をバックスラッシュでエスケープ
- 例: `Test [Name]` → `Test \[Name\]`

---

## 6. 実装計画

### 6.1 ファイル構成

```
src/
├── app/
│   ├── user/
│   │   └── [username]/
│   │       └── page.tsx          # ✅ ユーザープロファイルページ
│   └── api/
│       └── github/
│           ├── __tests__/
│           │   ├── search-users.test.ts  # ✅ ユーザー検索APIテスト
│           │   └── user.test.ts          # ✅ ユーザープロファイルAPIテスト
│           ├── search-users/
│           │   └── route.ts      # ✅ ユーザー検索API
│           └── user/
│               └── [username]/
│                   └── route.ts  # ✅ ユーザープロファイルAPI
├── components/
│   ├── AppHeader.tsx             # ✅ 共通ヘッダー
│   ├── DashboardLayout.tsx       # ✅ 統一レイアウト（StatCard, SectionCard含む）
│   ├── RepoSearchCombobox.tsx    # ✅ 修正: ユーザー検索対応
│   └── charts/
│       ├── LanguagesPieChart.tsx # ✅ 既存を再利用
│       ├── ActivityHeatmap.tsx   # ❌ 未作成（Phase 2）
│       └── ContributionTypePie.tsx  # ❌ 未作成（Phase 2）
├── hooks/
│   ├── useSearchRepositories.ts  # ✅ 修正: ユーザー検索モード追加
│   └── useUserProfile.ts         # ❌ 未作成（page.tsx内でfetch）
└── lib/
    ├── github.ts                 # ✅ 修正: ユーザー検索API追加
    └── __tests__/
        └── github.test.ts        # ✅ ヘルパー関数テスト追加
```

### 6.2 実装順序

| 順序 | タスク | 依存関係 | 状態 |
|------|--------|----------|------|
| 1 | `AppHeader.tsx` 共通ヘッダー作成 | - | ✅ 完了 |
| 2 | `DashboardLayout.tsx` 統一レイアウト作成 | 1 | ✅ 完了 |
| 3 | `/user/[username]/page.tsx` 新デザイン適用 | 2 | ✅ 完了 |
| 4 | `/repo/[owner]/[repo]/page.tsx` 新デザイン適用 | 2 | ✅ 完了 |
| 5 | `/dashboard/page.tsx` 共通コンポーネントに置き換え | 2 | ✅ 完了 |
| 6 | バッジ表示・ポップオーバー | 3 | ✅ 完了 |
| 7 | OGカードモーダル（Download/Copy URL/Copy Markdown） | 3 | ✅ 完了 |
| 8 | アクティビティヒートマップ | 3 | ❌ Phase 2 |
| 9 | 貢献タイプ分布グラフ | 3 | ❌ Phase 2 |

---

## 7. 技術的考慮事項

### 7.1 APIレート制限
- 未認証: 60回/時間
- 認証済み: 5,000回/時間
- Search API: 30回/分

**対策:**
- クライアントサイドキャッシュ（React Query staleTime: 30分）
- デバウンスによるリクエスト削減

> ⚠️ **注意**: サーバーサイドの `unstable_cache` は認証トークンのクロージャ問題があるため使用しない。
> キャッシュされた関数内の `accessToken` が最初のリクエスト時の値で固定され、認証状態が正しく反映されない。

### 6.2 制約事項
| 項目 | 制約 | 対応 |
|------|------|------|
| イベント履歴 | 直近90日/300件まで | 「過去90日間のアクティビティ」と表示 |
| プライベートリポジトリ | 取得不可 | 公開リポジトリのみ対象と明記 |
| コントリビューショングラフ | GraphQL API必要 | イベント履歴ベースで代替 |

### 7.3 エラーハンドリング
| ケース | 対応 |
|--------|------|
| ユーザーが見つからない | 404ページ表示 |
| APIレート制限 | 警告表示 + リトライ案内 |
| ネットワークエラー | エラーメッセージ + 再試行ボタン |

---

## 8. 将来の拡張可能性

- 組織(Organization)プロファイル対応
- ユーザー間比較機能
- 認証ユーザーのプライベート統計表示
- コントリビューショングラフ（GraphQL API使用）
