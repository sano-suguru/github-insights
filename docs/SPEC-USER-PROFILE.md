# ユーザー検索・プロファイル機能 仕様書

> 作成日: 2025-12-14
> ステータス: 実装中（基本機能完了）

## 1. 概要

### 1.1 目的
ユーザー（GitHub アカウント）を検索し、その活動統計を可視化する機能を提供する。

### 1.2 ユースケース
- 他の開発者のGitHub活動を確認したい
- 特定ユーザーのOGカードを生成・共有したい
- 自分のGitHubプロファイルを可視化したい

### 1.3 スコープ
| 含む | 含まない |
|------|----------|
| ユーザー検索 | 組織(Organization)検索 |
| ユーザープロファイルページ | ユーザー間比較 |
| 統計グラフ表示 | プライベート統計 |
| OGカード生成（既存機能連携） | フォロー/アンフォロー操作 |

---

## 2. ユーザーフロー

```
[検索バー] 
    │
    ├─ "facebook/react" → リポジトリ検索（既存）
    │
    └─ "@torvalds" → ユーザー検索（新規）
                          │
                          ▼
                    [検索結果表示]
                          │
                          ▼
                    [ユーザー選択]
                          │
                          ▼
                    [/user/[username]]
                          │
                          ├─ プロファイル情報
                          ├─ 統計グラフ
                          └─ OGカード生成
```

---

## 3. 検索機能

### 3.1 検索トリガー
- `@` で始まる入力をユーザー検索として処理
- 2文字以上で検索開始（デバウンス: 300ms）

### 3.2 検索API
```
GET https://api.github.com/search/users?q={query}&per_page=5
```

### 3.3 検索結果の詳細取得
Search API のレスポンスには詳細情報がないため、上位5件に対して追加取得:
```
GET https://api.github.com/users/{login}
```

### 3.4 検索結果の表示項目

> ⚠️ **実装時の変更**: レート制限対策として、Search APIの結果のみを使用。詳細情報（name, followers, publicRepos）はユーザープロファイルページで表示。

| 項目 | 必須 | ソース | 実装状況 |
|------|------|--------|----------|
| アバター画像 | ✅ | Search API | ✅ 実装済み |
| ログイン名 (`login`) | ✅ | Search API | ✅ 実装済み |
| 表示名 (`name`) | ○ | Users API | ❌ 検索結果では省略（プロファイルページで表示） |
| フォロワー数 | ○ | Users API | ❌ 検索結果では省略（プロファイルページで表示） |
| 公開リポジトリ数 | ○ | Users API | ❌ 検索結果では省略（プロファイルページで表示） |
| User/Organization 区別 | △ | Search API (`type`) | ✅ 実装済み |

### 3.5 検索結果UIモック

```
┌─────────────────────────────────────────────────────┐
│ 🔍 @torvalds                                    [×] │
└─────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────┐
│ 👤 ユーザー                                          │
├─────────────────────────────────────────────────────┤
│ ┌────┐  torvalds                                    │
│ │ 🖼️ │  Linus Torvalds                              │
│ └────┘  👥 200k · 📦 7 repos                        │
├─────────────────────────────────────────────────────┤
│ ┌────┐  torvalds-test                               │
│ │ 🖼️ │  Test Account                                │
│ └────┘  👥 5 · 📦 2 repos                           │
└─────────────────────────────────────────────────────┘
```

---

## 4. ユーザープロファイルページ

### 4.1 ルーティング
```
/user/[username]
```

### 4.2 データ取得

| データ | API | キャッシュ |
|--------|-----|-----------|
| ユーザー基本情報 | `GET /users/{username}` | 1時間 |
| リポジトリ一覧 | `GET /users/{username}/repos?sort=stars&per_page=100` | 1時間 |
| PR数 | `GET /search/issues?q=author:{user}+type:pr` | 1時間 |
| Issue数 | `GET /search/issues?q=author:{user}+type:issue` | 1時間 |
| イベント履歴 | `GET /users/{username}/events?per_page=100` | 30分 |

### 4.3 ページレイアウト

```
┌─────────────────────────────────────────────────────────────┐
│ [← 戻る]                                                    │
├─────────────────────────────────────────────────────────────┤
│ ┌──────┐                                                    │
│ │ 🖼️   │  torvalds                                         │
│ │      │  Linus Torvalds                                   │
│ └──────┘  📍 Portland, OR                                   │
│           👥 200k followers · 👤 0 following                │
│           📦 7 public repos · 📅 Joined 2011                │
│                                                             │
│           🏅 Veteran · Influencer · Prolific                │
│                                                             │
│           [📷 カードを生成]                                  │
├─────────────────────────────────────────────────────────────┤
│ ┌────────────────────────┐ ┌──────────────────────────────┐ │
│ │    📊 言語統計          │ │   🔥 アクティビティ           │ │
│ │    ┌───────────┐       │ │   ████████████████████████  │ │
│ │    │  C: 80%   │       │ │   ████████████████████████  │ │
│ │    │ Shell:15% │       │ │   ████████████████████████  │ │
│ │    └───────────┘       │ │                             │ │
│ └────────────────────────┘ └──────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ ┌────────────────────────┐ ┌──────────────────────────────┐ │
│ │    📈 貢献タイプ        │ │   ⭐ 人気リポジトリ           │ │
│ │    ┌───────────┐       │ │   1. linux      ⭐ 180k     │ │
│ │    │Commits 70%│       │ │   2. subsurface ⭐ 2.1k     │ │
│ │    │  PRs  20% │       │ │   3. test-tlb   ⭐ 500      │ │
│ │    │Issues 10% │       │ │   4. uemacs     ⭐ 300      │ │
│ │    └───────────┘       │ │   5. libdc...   ⭐ 200      │ │
│ └────────────────────────┘ └──────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 統計グラフ

| グラフ | 種類 | データソース | 説明 | 実装状況 |
|--------|------|-------------|------|----------|
| 言語統計 | 円グラフ | リポジトリ一覧の `language` | 全リポジトリの言語割合 | ✅ 実装済み |
| アクティビティ | ヒートマップ | イベント履歴 | 直近90日の活動頻度 | ❌ 未実装 |
| 貢献タイプ分布 | 円グラフ | PR数/Issue数/イベント | 活動の内訳 | ❌ 未実装 |
| 人気リポジトリ | リスト | リポジトリ一覧 | スター数上位10件 | ✅ 実装済み |

### 4.5 バッジ

> ⚠️ **未実装**: ユーザープロファイルページでのバッジ表示は未実装。既存の `/api/og/card/user/[user]` のロジックを流用予定。

既存の `/api/og/card/user/[user]` と同じロジックを使用:

| バッジ | 条件 |
|--------|------|
| Influencer | フォロワー 1,000人以上 |
| Popular | フォロワー 100人以上 |
| Prolific | リポジトリ 50個以上 |
| Builder | リポジトリ 20個以上 |
| PR Master | PR 100件以上 |
| Contributor | PR 50件以上 |
| Veteran | 2015年以前にアカウント作成 |

### 4.6 OGカード生成

> ⚠️ **未実装**: ユーザープロファイルページからのOGカード生成ボタンは未実装。API自体は既存。

既存の `/api/og/card/user/[user]` を使用。モーダルで表示・ダウンロード・共有。

---

## 5. 実装計画

### 5.1 ファイル構成

```
src/
├── app/
│   ├── user/
│   │   └── [username]/
│   │       └── page.tsx          # ✅ ユーザープロファイルページ
│   └── api/
│       └── github/
│           ├── __tests__/
│           │   ├── search-users.test.ts  # ✅ ユーザー検索APIテスト
│           │   └── user.test.ts          # ✅ ユーザープロファイルAPIテスト
│           ├── search-users/
│           │   └── route.ts      # ✅ ユーザー検索API
│           └── user/
│               └── [username]/
│                   └── route.ts  # ✅ ユーザープロファイルAPI
├── components/
│   ├── RepoSearchCombobox.tsx    # ✅ 修正: ユーザー検索対応
│   ├── UserProfileHeader.tsx     # ❌ 未作成（page.tsx内に実装）
│   ├── UserProfileCard.tsx       # ❌ 未作成（OGカードモーダルは未実装）
│   └── charts/
│       ├── LanguagesPieChart.tsx # ✅ 既存を再利用
│       └── ContributionTypePie.tsx  # ❌ 未作成
├── hooks/
│   ├── useSearchRepositories.ts  # ✅ 修正: ユーザー検索モード追加
│   └── useUserProfile.ts         # ❌ 未作成（page.tsx内でfetch）
└── lib/
    ├── github.ts                 # ✅ 修正: ユーザー検索API追加
    └── __tests__/
        └── github.test.ts        # ✅ ヘルパー関数テスト追加
```

### 5.2 実装順序

| 順序 | タスク | 依存関係 |
|------|--------|----------|
| 1 | `lib/github.ts` にユーザー検索関数追加 | - |
| 2 | `useSearch.ts` 作成（リポジトリ+ユーザー統合） | 1 |
| 3 | `RepoSearchCombobox.tsx` でユーザー検索対応 | 2 |
| 4 | `/user/[username]/page.tsx` 作成 | 1 |
| 5 | `useUserProfile.ts` 作成 | 1 |
| 6 | 各種グラフコンポーネント作成 | 5 |
| 7 | OGカードモーダル連携 | 4 |

---

## 6. 技術的考慮事項

### 6.1 APIレート制限
- 未認証: 60回/時間
- 認証済み: 5,000回/時間
- Search API: 30回/分

**対策:**
- サーバーサイドキャッシュ（Route Handler）
- クライアントサイドキャッシュ（React Query staleTime）
- デバウンスによるリクエスト削減

### 6.2 制約事項
| 項目 | 制約 | 対応 |
|------|------|------|
| イベント履歴 | 直近90日/300件まで | 「過去90日間のアクティビティ」と表示 |
| プライベートリポジトリ | 取得不可 | 公開リポジトリのみ対象と明記 |
| コントリビューショングラフ | GraphQL API必要 | イベント履歴ベースで代替 |

### 6.3 エラーハンドリング
| ケース | 対応 |
|--------|------|
| ユーザーが見つからない | 404ページ表示 |
| APIレート制限 | 警告表示 + リトライ案内 |
| ネットワークエラー | エラーメッセージ + 再試行ボタン |

---

## 7. 将来の拡張可能性

- 組織(Organization)プロファイル対応
- ユーザー間比較機能
- 認証ユーザーのプライベート統計表示
- コントリビューショングラフ（GraphQL API使用）
